<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Darts</title>
    <link rel="stylesheet" href="style.css">
</head>

<body>
    <div id="app">
        <div class="flex">
            
            <section class="definition">
                <h2>Mise en place</h2>
                <p>Soit une cible en forme de cercle, contenu dans un carré.</p>
                <cible :initial-radius="100"></cible>
                <h3>Règles du jeu</h3>
                <ol>
                    <li>Un joueur lance un dart sur la cible.</li>
                    <li>2 cas sont possibles
                        <ol>
                            <li>Si le joueur frappe la cible, on trace ainsi une ligne entre le point d'impact et le centre de la cible. On calcule ensuite la longueur du segment de corde perpendicualaire. Cette longueur sera le nouveau diamètre de la cible pour la prochaine ronde et on reprend à l'étape 1.
                            </li>
                            <li>Si le joueur ne frappe pas la cible, le jeu s'arrête et le joueur score le nombre de points égal au nombre de flèche qu'il a lancé.

                            </li>
                        </ol>
                    </li>
                </ol>
                <h3>Exemples</h3>
                <div class="flex" v-for="example in examples">
                    <table>
                        <tr>
                            <td v-for="(dart, index) in example.darts">Lancer {{ index + 1 }}</td>
                        </tr>
                        <tr>
                            <td v-for="n in example.darts.length"><cible :initial-radius="100" :darts-to-shoot-on-creation="example.darts.slice(0, n)"></cible></td>
                        </tr>
                    </table>
                    <p>{{example.label}}</p>
                </div>

                <h3>La Question</h3>
                <p>Si un joueur lance de façon uniforme, à chaque lancer, dans le carré de jeu. Quelle est l'espérence de son score?</p>
                
                <h3>La Réponse</h3>
            </section>
            <section class="playground">
                    <h2>Playground</h2>
                    <cible :show-stats="true" :show-controls="true"></cible>
                </section>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>
    <script>
        Vue.component('cible', {
            props: {
             initialRadius:{
                 default: 400
             },
             dartsToShootOnCreation: { default: function(){ return [] } },
             showControls: {default: false},
             showStats: {default: false}
            },
            data() {
                return {
                    currentRadius: 0,
                    currentScore: 0,
                    scores: [],
                    N: 1000,
                    lastDartMissed: false,
                    darts: [],
                    PI: 3.14159
                }
            },
            computed:{
                currentProbability(){
                    return Math.pow(this.currentRadius, 2) * this.PI / Math.pow(this.initialRadius * 2, 2)
                }
            },
            created() {
                this.restart()
                console.log(this.dartsToShootOnCreation)
                for(var i = 0; i < this.dartsToShootOnCreation.length; i++){
                    this.shootDart(this.dartsToShootOnCreation[i])
                }
            },
            methods: {
                restart() {
                    this.currentScore = 0
                    this.currentRadius = this.initialRadius
                    this.darts = []
                },
                xToMath(x) {
                    return x - this.initialRadius
                },
                yToMath(y) {
                    return this.initialRadius - y
                },
                xToPc(x) {
                    return this.initialRadius + x
                },
                yToPc(y) {
                    return this.initialRadius - y
                },
                shootDart(point) {
                    console.log(point)
                    if (this.lastDartMissed) {
                        this.scores.push(this.currentScore)
                        this.restart()
                    }
                    var dart = {
                        x: point ? point.x : Math.floor(Math.random() * this.initialRadius * 2),
                        y: point ? point.y : Math.floor(Math.random() * this.initialRadius * 2),
                        id: new Date().valueOf()
                    }
                    dart.currentRadius = this.currentRadius
                    dart.xMath = this.xToMath(dart.x);
                    dart.yMath = this.yToMath(dart.y);
                    dart.norm = Math.sqrt(Math.pow(dart.xMath, 2) + Math.pow(dart.yMath, 2))
                    dart.halfChordLength = Math.sqrt(Math.pow(this.currentRadius, 2) - Math.pow(dart.norm, 2))
                    dart.perpVector1Normalized = {
                        x: dart.yMath / dart.norm,
                        y: -dart.xMath / dart.norm
                    }
                    dart.perpVector2Normalized = {
                        x: -dart.yMath / dart.norm,
                        y: dart.xMath / dart.norm
                    }
                    dart.perpX1Pc = this.xToPc(dart.xMath + dart.perpVector1Normalized.x * dart.halfChordLength)
                    dart.perpY1Pc = this.yToPc(dart.yMath + dart.perpVector1Normalized.y * dart.halfChordLength)
                    dart.perpX2Pc = this.xToPc(dart.xMath + dart.perpVector2Normalized.x * dart.halfChordLength)
                    dart.perpY2Pc = this.yToPc(dart.yMath + dart.perpVector2Normalized.y * dart.halfChordLength)
                    dart.isHit = dart.norm <= this.currentRadius
                    this.darts.push(dart)
                    this.currentScore++
                    if (dart.isHit) {
                        this.currentRadius = dart.halfChordLength
                        this.lastDartMissed = false
                    } else {
                        this.lastDartMissed = true
                    }
                },
                shootDartLoop() {
                    for (let i = 0; i < this.N; i++) {
                        this.shootDart()
                    }
                }
            },
            template:
            '<div>'+
                    '<template v-if="showControls">'+
                '<br>' +
                '<button @click="shootDart(null)" class="btn">Lancer 1 dart</button>' +
                '<input type="number" v-model="N"><button class="btn" @click="shootDartLoop">Lancer {{ N }} darts</button>' +
            '</template>' +
            '<svg :width="initialRadius * 2" :height="initialRadius * 2">' +
            '<circle class="dartArea initial" :cx="initialRadius" :cy="initialRadius" :r="initialRadius" />' +
            '<circle class="dartArea current" :cx="initialRadius" :cy="initialRadius" :r="currentRadius" />' +
            '<line class="axis horizontal" :x1="initialRadius" :y1="0" :x2="initialRadius" :y2="initialRadius * 2" />' +
            '<line class="axis vertical" :x1="0" :y1="initialRadius" :x2="initialRadius * 2" :y2="initialRadius" />' +
            '<circle class="dartArea current" v-if="dart.isHit && i > 0" v-for="(dart, i) in darts" :cx="initialRadius" :cy="initialRadius" :r="dart.currentRadius" />' +
            '<line class="construction" v-if="dart.isHit" v-for="dart in darts" :x1="dart.x" :y1="dart.y" :x2="initialRadius" :y2="initialRadius" />' +
            '<line class="construction" v-if="dart.isHit" v-for="dart in darts" :x1="dart.perpX1Pc" :y1="dart.perpY1Pc" :x2="dart.perpX2Pc" :y2="dart.perpY2Pc" />' +
            '<circle class="dart" :class="{hit: dart.isHit}" v-for="dart in darts" :cx="dart.x" :cy="dart.y" :r="3" />' +
            '</svg>' +
            '<template v-if="showStats">' +
                '<p>Rayon courant: {{ Math.floor(currentRadius) }}</p>' +
                '<p>Probabilité de frapper la cible au prochain lancer: {{ Math.floor(currentProbability * 10000) / 100 }} %</p>' +
                '<p>Score courant: {{ currentScore }}</p>' +
                '<p>Score moyen: {{ scores.reduce((acc, curr) => acc + curr, 0) / scores.length }}</p>' +
                '<p>Nombre d\'essais: {{ scores.length }}</p>' +
            '</template>' +
            '</div>'
        })
        var app = new Vue({
            el: "#app",
            data: {
                examples:[
                    {
                        r: 100,
                        darts: [{x: 10, y: 15}],
                        label: "Le joueur rate son premier lancer, il marque 1 point."
                    },
                    {
                        r: 100,
                        darts: [{x: 50, y: 30}, {x:115,y:170}],
                        label: "Le joueur réussit le premier lancer, la cible rétréssit et il rate le deuxième lancer. Il marque ainsi 2 points."
                    },
                    {
                        r: 100,
                        darts: [{x: 120, y: 150},{x:140, y:70}, {x:45 ,y:42}],
                        label: "Le joueur marque 3 points."
                    },
                    
                ]
            }
        })
    </script>
</body>

</html>